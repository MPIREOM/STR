<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Muscat STR Market Size ‚Äî Investor Map</title>

  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    * { font-family: 'Space Grotesk', sans-serif; }
    body { background:#0a0e1a; }
    #map { z-index: 1; }
    .control-panel { z-index: 1000; }

    /* Glow keyframes ‚Äî only used on hover now */
    @keyframes pulseGlow {
      0%, 100% { box-shadow: 0 0 8px 2px var(--glow-color, rgba(99,102,241,0.4)); }
      50% { box-shadow: 0 0 18px 6px var(--glow-color, rgba(99,102,241,0.6)); }
    }
    @keyframes fadeSlideUp {
      from { opacity: 0; transform: translateY(12px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes borderGlow {
      0%, 100% { border-color: rgba(99,102,241,0.25); }
      50% { border-color: rgba(99,102,241,0.5); }
    }

    /* Dark glassmorphism popup */
    .custom-popup .leaflet-popup-content-wrapper{
      background: rgba(10,14,26,0.92);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      color:#fff;
      border-radius: 16px;
      border: 1px solid rgba(99,102,241,0.3);
      box-shadow: 0 16px 40px rgba(0,0,0,0.5), 0 0 20px rgba(99,102,241,0.15);
      animation: fadeSlideUp 0.25s ease-out;
    }
    .custom-popup .leaflet-popup-tip{ background: rgba(10,14,26,0.92); }

    /* Marker transitions on hover only */
    .custom-marker div {
      transition: transform 0.2s ease, box-shadow 0.2s ease !important;
    }

    /* Custom cluster styling */
    .marker-cluster-small, .marker-cluster-medium, .marker-cluster-large {
      background: rgba(99,102,241,0.25) !important;
      border: 2px solid rgba(99,102,241,0.5) !important;
    }
    .marker-cluster-small div, .marker-cluster-medium div, .marker-cluster-large div {
      background: rgba(99,102,241,0.7) !important;
      color: #fff !important;
      font-family: 'Space Grotesk', sans-serif !important;
      font-weight: 600 !important;
    }
    .marker-cluster-medium, .marker-cluster-medium div {
      background: rgba(96,165,250,0.25) !important;
    }
    .marker-cluster-medium { border-color: rgba(96,165,250,0.5) !important; }
    .marker-cluster-medium div { background: rgba(96,165,250,0.7) !important; }
    .marker-cluster-large, .marker-cluster-large div {
      background: rgba(251,191,36,0.25) !important;
    }
    .marker-cluster-large { border-color: rgba(251,191,36,0.5) !important; }
    .marker-cluster-large div { background: rgba(251,191,36,0.7) !important; }

    /* Leaflet attribution dark */
    .leaflet-control-attribution {
      background: rgba(10,14,26,0.7) !important;
      color: rgba(255,255,255,0.4) !important;
    }
    .leaflet-control-attribution a { color: rgba(139,146,255,0.7) !important; }
    .leaflet-control-zoom a {
      background: rgba(10,14,26,0.85) !important;
      color: #fff !important;
      border-color: rgba(99,102,241,0.3) !important;
    }
    .leaflet-control-zoom a:hover {
      background: rgba(99,102,241,0.3) !important;
    }

    /* Scrollbar dark */
    #dashboard-body::-webkit-scrollbar { width: 4px; }
    #dashboard-body::-webkit-scrollbar-track { background: transparent; }
    #dashboard-body::-webkit-scrollbar-thumb { background: rgba(99,102,241,0.3); border-radius: 4px; }

    /* Mobile: bottom-sheet */
    @media (max-width: 768px){
      #dashboard{
        left: 0 !important;
        right: 0 !important;
        top: auto !important;
        bottom: 0 !important;
        width: auto !important;
        max-height: 75vh;
        border-radius: 18px 18px 0 0;
        padding: 16px !important;
        overflow-y: auto;
      }
      #dashboard.minimized{
        max-height: 56px;
        overflow: hidden;
        padding: 12px 16px !important;
      }
      #dashboard.minimized #dashboard-body{ display:none; }

      .kpi-grid { grid-template-columns: repeat(2, 1fr) !important; }
      .tier-grid { grid-template-columns: 1fr !important; }
      .filter-grid { grid-template-columns: 1fr !important; }
    }

    /* Small phones */
    @media (max-width: 380px){
      .kpi-grid { grid-template-columns: 1fr !important; }
    }

    /* Desktop: keep top-left */
    @media (min-width: 769px){
      #dashboard{
        top: 16px;
        left: 16px;
        right: auto;
        width: 30rem;
        max-height: calc(100vh - 32px);
      }
      #dashboard-body{
        overflow:auto;
        max-height: calc(100vh - 120px);
        padding-right: 4px;
      }
    }

    /* Mobile header compact */
    @media (max-width: 768px){
      #dashboard h1 { font-size: 1.15rem; }
      #dashboard-body {
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        max-height: calc(75vh - 80px);
        padding-right: 2px;
      }
    }
  </style>
</head>

<body class="h-full m-0 p-0">
  <div id="app-container" class="h-full w-full relative overflow-hidden">

    <!-- Dashboard -->
    <div id="dashboard" class="control-panel absolute rounded-2xl p-5 shadow-xl" style="background:rgba(10,14,26,0.88);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border:1px solid rgba(99,102,241,0.25);box-shadow:0 20px 60px rgba(0,0,0,0.5),0 0 30px rgba(99,102,241,0.1);animation:fadeSlideUp 0.4s ease-out, borderGlow 4s ease-in-out infinite">
      <!-- Mobile drag handle -->
      <div class="md:hidden flex justify-center mb-2">
        <div class="w-10 h-1 rounded-full" style="background:rgba(99,102,241,0.5)"></div>
      </div>
      <!-- Header row -->
      <div class="flex items-start justify-between gap-3">
        <div>
          <h1 class="text-2xl font-bold mb-1" style="color:#e0e4ff">Muscat STR Market Size</h1>
          <p class="text-sm" style="color:rgba(165,170,210,0.7)">Supply + Revenue Pool ‚Ä¢ Segmented by ADR Pricing Tier</p>
        </div>

        <div class="flex flex-col items-end gap-2">
          <div class="text-[11px] text-right leading-tight hidden md:block" style="color:rgba(165,170,210,0.5)">
            <div class="font-semibold" style="color:rgba(165,170,210,0.7)">Sources</div>
            <div>Airbtics (map)</div>
          </div>

          <!-- Minimize button -->
          <button id="toggle-btn"
            class="inline-flex items-center gap-2 text-xs px-3 py-2 rounded-lg min-h-[36px]"
            style="border:1px solid rgba(99,102,241,0.3);background:rgba(99,102,241,0.1);color:rgba(200,205,240,0.9);transition:all 0.2s ease"
            onmouseover="this.style.background='rgba(99,102,241,0.25)';this.style.borderColor='rgba(99,102,241,0.5)'"
            onmouseout="this.style.background='rgba(99,102,241,0.1)';this.style.borderColor='rgba(99,102,241,0.3)'"
            aria-label="Minimize dashboard">
            <span id="toggle-text">Minimize</span>
            <svg id="toggle-icon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
            </svg>
          </button>
        </div>
      </div>

      <div id="dashboard-body" class="mt-4 space-y-4">
        <!-- KPIs from map listings -->
        <div class="kpi-grid grid grid-cols-3 gap-3">
          <div class="rounded-xl p-3" style="background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);transition:all 0.2s ease" onmouseover="this.style.borderColor='rgba(99,102,241,0.4)';this.style.boxShadow='0 0 12px rgba(99,102,241,0.15)'" onmouseout="this.style.borderColor='rgba(255,255,255,0.08)';this.style.boxShadow='none'">
            <div class="text-[11px]" style="color:rgba(165,170,210,0.5)">Mapped listings</div>
            <div class="text-2xl font-bold" style="color:#e0e4ff" id="kpi-listings">--</div>
            <div class="text-[11px]" style="color:rgba(165,170,210,0.5)">&nbsp;</div>
          </div>
          <div class="rounded-xl p-3" style="background:rgba(16,185,129,0.06);border:1px solid rgba(16,185,129,0.15);transition:all 0.2s ease" onmouseover="this.style.borderColor='rgba(16,185,129,0.4)';this.style.boxShadow='0 0 12px rgba(16,185,129,0.15)'" onmouseout="this.style.borderColor='rgba(16,185,129,0.15)';this.style.boxShadow='none'">
            <div class="text-[11px]" style="color:rgba(165,170,210,0.5)">Revenue pool</div>
            <div class="text-2xl font-bold" style="color:#34d399" id="kpi-total-rev">--</div>
            <div class="text-[11px]" style="color:rgba(165,170,210,0.5)">OMR / month</div>
          </div>
          <div class="rounded-xl p-3" style="background:rgba(99,102,241,0.06);border:1px solid rgba(99,102,241,0.15);transition:all 0.2s ease" onmouseover="this.style.borderColor='rgba(99,102,241,0.4)';this.style.boxShadow='0 0 12px rgba(99,102,241,0.15)'" onmouseout="this.style.borderColor='rgba(99,102,241,0.15)';this.style.boxShadow='none'">
            <div class="text-[11px]" style="color:rgba(165,170,210,0.5)">Annualized</div>
            <div class="text-2xl font-bold" style="color:#818cf8" id="kpi-annual">--</div>
            <div class="text-[11px]" style="color:rgba(165,170,210,0.5)">OMR / year</div>
          </div>
        </div>

        <div class="kpi-grid grid grid-cols-3 gap-3">
          <div class="rounded-xl p-3" style="background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);transition:all 0.2s ease" onmouseover="this.style.borderColor='rgba(99,102,241,0.4)';this.style.boxShadow='0 0 12px rgba(99,102,241,0.15)'" onmouseout="this.style.borderColor='rgba(255,255,255,0.08)';this.style.boxShadow='none'">
            <div class="text-[11px]" style="color:rgba(165,170,210,0.5)">Avg ADR</div>
            <div class="text-xl font-bold" style="color:#e0e4ff" id="kpi-adr">--</div>
            <div class="text-[11px]" style="color:rgba(165,170,210,0.5)">OMR</div>
          </div>
          <div class="rounded-xl p-3" style="background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);transition:all 0.2s ease" onmouseover="this.style.borderColor='rgba(99,102,241,0.4)';this.style.boxShadow='0 0 12px rgba(99,102,241,0.15)'" onmouseout="this.style.borderColor='rgba(255,255,255,0.08)';this.style.boxShadow='none'">
            <div class="text-[11px]" style="color:rgba(165,170,210,0.5)">Avg occupancy</div>
            <div class="text-xl font-bold" style="color:#e0e4ff" id="kpi-occ">--</div>
            <div class="text-[11px]" style="color:rgba(165,170,210,0.5)">&nbsp;</div>
          </div>
          <div class="rounded-xl p-3" style="background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);transition:all 0.2s ease" onmouseover="this.style.borderColor='rgba(99,102,241,0.4)';this.style.boxShadow='0 0 12px rgba(99,102,241,0.15)'" onmouseout="this.style.borderColor='rgba(255,255,255,0.08)';this.style.boxShadow='none'">
            <div class="text-[11px]" style="color:rgba(165,170,210,0.5)">Avg rev / listing</div>
            <div class="text-xl font-bold" style="color:#e0e4ff" id="kpi-avg-rev">--</div>
            <div class="text-[11px]" style="color:rgba(165,170,210,0.5)">OMR / month</div>
          </div>
        </div>

        <!-- Tier legend + counts -->
        <div class="rounded-xl p-3" style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08)">
          <div class="flex items-center justify-between">
            <div class="text-xs font-semibold" style="color:rgba(200,205,240,0.8)">Pricing tiers (ADR)</div>
            <div class="text-[11px]" style="color:rgba(165,170,210,0.5)">Color = tier ‚Ä¢ Size = monthly revenue</div>
          </div>
          <div class="tier-grid mt-2 grid grid-cols-3 gap-2">
            <div class="flex items-center justify-between rounded-lg px-3 py-2" style="background:rgba(168,162,255,0.06);border:1px solid rgba(168,162,255,0.15)">
              <div class="flex items-center gap-2">
                <span class="inline-block w-3 h-3 rounded-full" style="background:#a8a2ff;box-shadow:0 0 6px rgba(168,162,255,0.5)"></span>
                <span class="text-xs" style="color:rgba(200,205,240,0.8)">Low</span>
              </div>
              <span class="text-xs font-semibold" style="color:#e0e4ff" id="count-low">--</span>
            </div>
            <div class="flex items-center justify-between rounded-lg px-3 py-2" style="background:rgba(59,130,246,0.06);border:1px solid rgba(59,130,246,0.15)">
              <div class="flex items-center gap-2">
                <span class="inline-block w-3 h-3 rounded-full" style="background:#60a5fa;box-shadow:0 0 6px rgba(96,165,250,0.5)"></span>
                <span class="text-xs" style="color:rgba(200,205,240,0.8)">Mid</span>
              </div>
              <span class="text-xs font-semibold" style="color:#e0e4ff" id="count-mid">--</span>
            </div>
            <div class="flex items-center justify-between rounded-lg px-3 py-2" style="background:rgba(250,204,21,0.06);border:1px solid rgba(250,204,21,0.15)">
              <div class="flex items-center gap-2">
                <span class="inline-block w-3 h-3 rounded-full" style="background:#fbbf24;box-shadow:0 0 6px rgba(251,191,36,0.5)"></span>
                <span class="text-xs" style="color:rgba(200,205,240,0.8)">Luxury</span>
              </div>
              <span class="text-xs font-semibold" style="color:#e0e4ff" id="count-lux">--</span>
            </div>
          </div>
          <div class="mt-2 text-[11px]" style="color:rgba(165,170,210,0.5)">
            Thresholds: Low &lt; <span class="font-semibold" id="th-low">35</span> ‚Ä¢ Mid <span class="font-semibold" id="th-mid">35‚Äì55</span> ‚Ä¢ Luxury &gt; <span class="font-semibold" id="th-lux">55</span> (OMR ADR)
          </div>
        </div>

        <!-- Filters -->
        <div class="grid grid-cols-1 gap-3">
          <div class="filter-grid grid grid-cols-2 gap-3">
            <div>
              <label class="text-xs mb-1 block" style="color:rgba(165,170,210,0.6)">Neighborhood (City)</label>
              <select id="neighborhood-filter" class="w-full rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2" style="background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);color:#e0e4ff;focus-ring-color:rgba(99,102,241,0.4)">
                <option value="all">All</option>
              </select>
            </div>
            <div>
              <label class="text-xs mb-1 block" style="color:rgba(165,170,210,0.6)">Listing Type</label>
              <select id="type-filter" class="w-full rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2" style="background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);color:#e0e4ff">
                <option value="all">All</option>
              </select>
            </div>
          </div>

          <div class="filter-grid grid grid-cols-2 gap-3">
            <div>
              <label class="text-xs mb-1 block" style="color:rgba(165,170,210,0.6)">Pricing tier</label>
              <select id="tier-filter" class="w-full rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2" style="background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);color:#e0e4ff">
                <option value="all">All tiers</option>
                <option value="low">Low</option>
                <option value="mid">Mid</option>
                <option value="luxury">Luxury</option>
              </select>
            </div>
            <div>
              <label class="text-xs mb-1 block" style="color:rgba(165,170,210,0.6)">View</label>
              <select id="view-filter" class="w-full rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2" style="background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);color:#e0e4ff">
                <option value="all">All listings</option>
                <option value="top20">Top 20% by revenue</option>
              </select>
            </div>
          </div>
        </div>

        <div class=‚Äùtext-[11px]‚Äù style=‚Äùcolor:rgba(165,170,210,0.4)‚Äù>
          Tip: On mobile, tap ‚ÄúMinimize‚Äù to view the map. Click any point for Airbnb + Google Maps links.
        </div>
      </div>
    </div>

    <!-- Map -->
    <div id="map" class="h-full w-full"></div>

    <!-- Property panel -->
    <div id="property-panel" class="control-panel absolute bottom-4 left-4 right-4 md:left-auto md:right-4 md:w-96 rounded-2xl p-5 hidden" style="background:rgba(10,14,26,0.88);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border:1px solid rgba(99,102,241,0.25);box-shadow:0 20px 60px rgba(0,0,0,0.5),0 0 30px rgba(99,102,241,0.1);animation:fadeSlideUp 0.3s ease-out">
      <div class="flex justify-between items-start mb-3">
        <h3 id="p-name" class="text-lg font-semibold pr-2" style="color:#e0e4ff">Property</h3>
        <button id="p-close" class="transition-colors" style="color:rgba(165,170,210,0.5)" onmouseover="this.style.color='#e0e4ff'" onmouseout="this.style.color='rgba(165,170,210,0.5)'" aria-label="Close">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>

      <div class="space-y-2 text-sm">
        <div class="flex justify-between"><span style="color:rgba(165,170,210,0.6)">City</span><span id="p-city" class="font-medium" style="color:#e0e4ff">--</span></div>
        <div class="flex justify-between"><span style="color:rgba(165,170,210,0.6)">Listing Type</span><span id="p-type" class="font-medium" style="color:#e0e4ff">--</span></div>
        <div class="flex justify-between"><span style="color:rgba(165,170,210,0.6)">Pricing tier</span><span id="p-tier" class="font-medium" style="color:#e0e4ff">--</span></div>
        <div class="flex justify-between"><span style="color:rgba(165,170,210,0.6)">Monthly revenue</span><span id="p-rev" class="font-semibold" style="color:#34d399">--</span></div>
        <div class="flex justify-between"><span style="color:rgba(165,170,210,0.6)">ADR</span><span id="p-adr" class="font-medium" style="color:#e0e4ff">--</span></div>
        <div class="flex justify-between"><span style="color:rgba(165,170,210,0.6)">Occupancy</span><span id="p-occ" class="font-medium" style="color:#e0e4ff">--</span></div>

        <div class="pt-3 flex gap-2">
          <a id="p-airbnb" target="_blank" rel="noopener noreferrer"
             class="flex-1 text-center text-sm px-3 py-2 rounded-lg font-semibold transition-all" style="background:rgba(99,102,241,0.8);color:#fff;border:1px solid rgba(99,102,241,0.5)" onmouseover="this.style.background='rgba(99,102,241,1)';this.style.boxShadow='0 0 15px rgba(99,102,241,0.4)'" onmouseout="this.style.background='rgba(99,102,241,0.8)';this.style.boxShadow='none'">
            Open Airbnb
          </a>
          <a id="p-maps" target="_blank" rel="noopener noreferrer"
             class="flex-1 text-center text-sm px-3 py-2 rounded-lg font-semibold transition-all" style="background:rgba(255,255,255,0.06);color:#e0e4ff;border:1px solid rgba(255,255,255,0.15)" onmouseover="this.style.background='rgba(255,255,255,0.12)';this.style.borderColor='rgba(99,102,241,0.4)'" onmouseout="this.style.background='rgba(255,255,255,0.06)';this.style.borderColor='rgba(255,255,255,0.15)'">
            Open Maps
          </a>
        </div>
      </div>
    </div>

  </div>

  <script>
    // =========================
    // SETTINGS
    // =========================
    const USD_TO_OMR = 0.385; // Omani Rial pegged rate
    const ADR_LOW_MAX = 35;   // Low: < 35
    const ADR_MID_MAX = 55;   // Mid: 35‚Äì55, Luxury: > 55

    document.getElementById('th-low').textContent = ADR_LOW_MAX;
    document.getElementById('th-mid').textContent = `${ADR_LOW_MAX}‚Äì${ADR_MID_MAX}`;
    document.getElementById('th-lux').textContent = ADR_MID_MAX;

    // Files (place alongside this HTML on GitHub Pages)
    const LISTINGS_CSV_URL = "./airroi_atlas_all_listings_with_airbnb_ids.csv";

    // =========================
    // STATE
    // =========================
    let map;
    let markers = [];
    let clusterGroup = null;
    let allData = [];
    let filteredData = [];

    // =========================
    // HELPERS
    // =========================
    const fmtOMR = (n) => Number(n || 0).toLocaleString('en-US', { maximumFractionDigits: 0 });
    const clamp = (v, min, max) => Math.max(min, Math.min(max, v));

    function tierFromADR(adr){
      const a = Number(adr || 0);
      if (a > ADR_MID_MAX) return "luxury";
      if (a >= ADR_LOW_MAX) return "mid";
      return "low";
    }
    function tierLabel(t){
      if (t === "luxury") return "Luxury";
      if (t === "mid") return "Mid";
      return "Low";
    }
    function tierColor(t){
      if (t === "luxury") return "#fbbf24";
      if (t === "mid") return "#60a5fa";
      return "#a8a2ff";
    }
    function tierGlow(t){
      if (t === "luxury") return "rgba(251,191,36,0.6)";
      if (t === "mid") return "rgba(96,165,250,0.6)";
      return "rgba(168,162,255,0.6)";
    }
    function markerSizeFromRevenue(rev){
      const r = Math.sqrt(Math.max(0, Number(rev || 0))) * 0.35;
      return clamp(r, 10, 34);
    }
    function topPercentByRevenue(data, pct){
      const sorted = [...data].sort((a,b)=> (b.revenue||0) - (a.revenue||0));
      const k = Math.max(1, Math.round(sorted.length * pct));
      return sorted.slice(0, k);
    }

    // =========================
    // CSV PARSE (simple, robust for this export)
    // =========================
    function parseCSVLine(line){
      // handles commas inside quotes
      const out = [];
      let cur = "";
      let inQuotes = false;
      for (let i=0; i<line.length; i++){
        const ch = line[i];
        if (ch === '"'){
          if (inQuotes && line[i+1] === '"'){ cur += '"'; i++; }
          else inQuotes = !inQuotes;
        } else if (ch === ',' && !inQuotes){
          out.push(cur); cur = "";
        } else {
          cur += ch;
        }
      }
      out.push(cur);
      return out;
    }

    function normalizeHeaderName(value){
      return (value || "")
        .toString()
        .trim()
        .toLowerCase()
        .replace(/\s+/g, " ");
    }

    function getColumnIndex(headerMap, candidates){
      for (const candidate of candidates){
        const idx = headerMap[normalizeHeaderName(candidate)];
        if (Number.isInteger(idx)) return idx;
      }
      return -1;
    }

    function splitCSVRows(text){
      // Split CSV text into logical rows, respecting quoted fields that may
      // contain embedded newlines.
      const rows = [];
      let cur = "";
      let inQuotes = false;
      for (let i = 0; i < text.length; i++){
        const ch = text[i];
        if (ch === '"'){
          if (inQuotes && text[i+1] === '"'){ cur += '""'; i++; }
          else inQuotes = !inQuotes;
          cur += ch;
        } else if ((ch === '\n' || ch === '\r') && !inQuotes){
          if (ch === '\r' && text[i+1] === '\n') i++; // skip \r\n
          if (cur.trim().length) rows.push(cur);
          cur = "";
        } else {
          cur += ch;
        }
      }
      if (cur.trim().length) rows.push(cur);
      return rows;
    }

    async function loadListingsCSV(){
      const res = await fetch(LISTINGS_CSV_URL);
      const text = await res.text();
      const lines = splitCSVRows(text);

      // skip comment lines that start with '#'
      const dataLines = lines.filter(l => !l.trim().startsWith("#"));
      if (dataLines.length < 2) return [];

      // header row is the first non-comment line
      const header = parseCSVLine(dataLines[0]);
      const headerMap = {};
      header.forEach((name, idx) => {
        headerMap[normalizeHeaderName(name)] = idx;
      });

      const idxListingId = getColumnIndex(headerMap, ["Listing ID"]);
      const idxName = getColumnIndex(headerMap, ["Name", "listingName"]);
      const idxLatitude = getColumnIndex(headerMap, ["Latitude", "latitude"]);
      const idxLongitude = getColumnIndex(headerMap, ["Longitude", "longitude"]);
      const idxGoogleMapsUrl = getColumnIndex(headerMap, ["Google Maps URL", "googleMapsLink"]);
      const idxAirbnbUrl = getColumnIndex(headerMap, ["Airbnb URL", "AirBnBLink"]);
      const idxPropertyType = getColumnIndex(headerMap, ["Property Type", "listingType"]);
      const idxRoomType = getColumnIndex(headerMap, ["Room Type"]);
      const idxAnnualRevenue = getColumnIndex(headerMap, ["Annual Revenue LTM (USD)", "RevenuePerYear"]);
      const idxAdr = getColumnIndex(headerMap, ["Avg Daily Rate LTM (USD)", "ADR"]);
      const idxOccupancy = getColumnIndex(headerMap, ["Avg Occupancy Rate LTM (%)", "occupancyRate"]);

      const rows = dataLines.slice(1).map(parseCSVLine);

      const parsed = [];
      for (const r of rows){
        if (!r || !r.length) continue;

        const listingName = (r[idxName] || "").replace(/[\r\n]+/g, " ").trim();
        const propertyType = (r[idxPropertyType] || "").trim();
        const roomType = (r[idxRoomType] || "").trim();
        const listingType = [propertyType, roomType].filter(Boolean).join(" ‚Ä¢ ") || propertyType || "‚Äî";

        const lat = Number((r[idxLatitude] || "").trim());
        const lng = Number((r[idxLongitude] || "").trim());
        if (!Number.isFinite(lat) || !Number.isFinite(lng) || (lat === 0 && lng === 0)) continue;

        const googleMapsLinkRaw = (r[idxGoogleMapsUrl] || "").trim();
        const maybeAirbnbUrl = (r[idxAirbnbUrl] || "").trim();
        const airbnbListingIdMatch = maybeAirbnbUrl.match(/rooms\/(\d+)/);
        const listingIdRaw = (r[idxListingId] || "").trim();
        const airbnbListingId = airbnbListingIdMatch ? airbnbListingIdMatch[1] : listingIdRaw;
        
        const airbnbUrl = (maybeAirbnbUrl.includes("airbnb.com/rooms"))
          ? maybeAirbnbUrl
          : (airbnbListingId ? `https://www.airbnb.com/rooms/${airbnbListingId}` : "");

        const city = "Muscat";

        const annualRevenueUsd = Number((r[idxAnnualRevenue] || "").trim());
        const revenue_omr = (annualRevenueUsd * USD_TO_OMR) / 12;
        const adr = Number((r[idxAdr] || "").trim()) * USD_TO_OMR;
        const rawOcc = Number((r[idxOccupancy] || "").trim());
        const occ_pct = rawOcc <= 1 ? rawOcc * 100 : rawOcc;
        
        const mapsUrl = (googleMapsLinkRaw && googleMapsLinkRaw.startsWith("http"))
          ? googleMapsLinkRaw
          : `https://www.google.com/maps?q=${lat},${lng}`;

        const tier = tierFromADR(adr);

        parsed.push({
          id: airbnbListingId || `${lat},${lng},${listingName}`,
          airbnbListingId,
          name: listingName || "Airbnb listing",
          type: listingType || "‚Äî",
          city,
          lat, lng,
          mapsUrl,
          airbnbUrl,
          revenue: Number.isFinite(revenue_omr) ? revenue_omr : 0,
          adr: Number.isFinite(adr) ? adr : 0,
          occupancy: Number.isFinite(occ_pct) ? clamp(occ_pct, 0, 100) : 0,
          tier
        });
      }

      return parsed;
    }

    // =========================
    // MARKERS + UI
    // =========================
    function createMarker(item) {
      const color = tierColor(item.tier);
      const glow = tierGlow(item.tier);
      const size = markerSizeFromRevenue(item.revenue);
      const outerSize = size + 10;

      const markerHtml = `
        <div class="marker-outer" style="
          position:relative;
          width:${outerSize}px;height:${outerSize}px;
          display:flex;align-items:center;justify-content:center;
        ">
          <div class="marker-ring" style="
            position:absolute;inset:0;
            border-radius:9999px;
            background:${color};
            opacity:0.12;
            --glow-color:${glow};
          "></div>
          <div class="marker-dot" style="
            width:${size}px;height:${size}px;
            background:${color};
            border:2px solid rgba(255,255,255,0.7);
            border-radius:9999px;
            box-shadow:0 0 6px ${glow};
            cursor:pointer;
            position:relative;z-index:2;
          "></div>
        </div>
      `;

      const icon = L.divIcon({
        html: markerHtml,
        className: 'custom-marker',
        iconSize: [outerSize, outerSize],
        iconAnchor: [outerSize/2, outerSize/2]
      });

      const marker = L.marker([item.lat, item.lng], { icon })
        .bindPopup(`
          <div class="p-2">
            <div class="font-semibold text-base mb-2" style="color:#e0e4ff">${item.name}</div>
            <div class="text-xs space-y-1" style="color:rgba(200,205,240,0.7)">
              <div>üìç ${item.city}</div>
              <div>üè† ${item.type}</div>
              <div>üè∑ Tier: <span style="color:${color};font-weight:700;text-shadow:0 0 8px ${glow}">${tierLabel(item.tier)}</span></div>
              <div>üí∞ Monthly: <span style="color:#34d399;text-shadow:0 0 8px rgba(52,211,153,0.4)">${fmtOMR(item.revenue)} OMR</span></div>
              <div>üìà ADR: ${Math.round(item.adr)} OMR | Occ: ${Math.round(item.occupancy)}%</div>
              <div class="pt-2 flex gap-2">
                <a href="${item.airbnbUrl}" target="_blank" rel="noopener noreferrer"
                   style="display:inline-block;padding:6px 10px;border-radius:10px;background:rgba(99,102,241,0.8);color:#fff;font-weight:600;text-decoration:none;transition:all 0.2s">
                  Airbnb
                </a>
                <a href="${item.mapsUrl}" target="_blank" rel="noopener noreferrer"
                   style="display:inline-block;padding:6px 10px;border-radius:10px;background:rgba(255,255,255,0.08);color:#e0e4ff;font-weight:600;text-decoration:none;border:1px solid rgba(255,255,255,0.15);transition:all 0.2s">
                  Maps
                </a>
              </div>
            </div>
          </div>
        `, { className: 'custom-popup' });

      // hover effect with glow burst
      marker.on('mouseover', function(){
        const el = this.getElement();
        if (!el) return;
        const dot = el.querySelector('.marker-dot');
        const ring = el.querySelector('.marker-ring');
        if (dot) {
          dot.style.transform = "scale(1.2)";
          dot.style.boxShadow = `0 0 20px ${glow}, 0 0 40px ${glow}, 0 4px 16px rgba(0,0,0,0.4)`;
        }
        if (ring) { ring.style.opacity = "0.35"; ring.style.transform = "scale(1.3)"; }
      });
      marker.on('mouseout', function(){
        const el = this.getElement();
        if (!el) return;
        const dot = el.querySelector('.marker-dot');
        const ring = el.querySelector('.marker-ring');
        if (dot) {
          dot.style.transform = "scale(1)";
          dot.style.boxShadow = `0 0 12px ${glow}, 0 4px 16px rgba(0,0,0,0.4)`;
        }
        if (ring) { ring.style.opacity = "0.15"; ring.style.transform = "scale(1)"; }
      });

      return marker;
    }

    function showPropertyPanel(item) {
      document.getElementById('p-name').textContent = item.name;
      document.getElementById('p-city').textContent = item.city;
      document.getElementById('p-type').textContent = item.type;
      document.getElementById('p-tier').textContent = tierLabel(item.tier);
      document.getElementById('p-rev').textContent = `${fmtOMR(item.revenue)} OMR / month`;
      document.getElementById('p-adr').textContent = `${Math.round(item.adr)} OMR`;
      document.getElementById('p-occ').textContent = `${Math.round(item.occupancy)}%`;

      const airbnbA = document.getElementById('p-airbnb');
      const mapsA = document.getElementById('p-maps');
      airbnbA.href = item.airbnbUrl || "#";
      mapsA.href = item.mapsUrl || "#";

      document.getElementById('property-panel').classList.remove('hidden');
    }

    function closePropertyPanel() {
      document.getElementById('property-panel').classList.add('hidden');
    }

    function updateKPIs() {
      const n = filteredData.length;
      document.getElementById('kpi-listings').textContent = n.toLocaleString('en-US');

      if (!n) {
        document.getElementById('kpi-total-rev').textContent = "--";
        document.getElementById('kpi-annual').textContent = "--";
        document.getElementById('kpi-adr').textContent = "--";
        document.getElementById('kpi-occ').textContent = "--";
        document.getElementById('kpi-avg-rev').textContent = "--";
        document.getElementById('count-low').textContent = "--";
        document.getElementById('count-mid').textContent = "--";
        document.getElementById('count-lux').textContent = "--";
        return;
      }

      const totalRev = filteredData.reduce((s, x) => s + (x.revenue || 0), 0);
      const annual = totalRev * 12;
      const avgRev = totalRev / n;
      const adrItems = filteredData.filter(x => x.adr > 0);
      const occItems = filteredData.filter(x => x.occupancy > 0);
      const avgAdr = adrItems.length ? adrItems.reduce((s, x) => s + x.adr, 0) / adrItems.length : 0;
      const avgOcc = occItems.length ? occItems.reduce((s, x) => s + x.occupancy, 0) / occItems.length : 0;

      document.getElementById('kpi-total-rev').textContent = fmtOMR(Math.round(totalRev));
      document.getElementById('kpi-annual').textContent = fmtOMR(Math.round(annual));
      document.getElementById('kpi-avg-rev').textContent = fmtOMR(Math.round(avgRev));
      document.getElementById('kpi-adr').textContent = fmtOMR(Math.round(avgAdr));
      document.getElementById('kpi-occ').textContent = `${Math.round(avgOcc)}%`;

      const cLow = filteredData.filter(x => x.tier === "low").length;
      const cMid = filteredData.filter(x => x.tier === "mid").length;
      const cLux = filteredData.filter(x => x.tier === "luxury").length;
      document.getElementById('count-low').textContent = cLow.toLocaleString('en-US');
      document.getElementById('count-mid').textContent = cMid.toLocaleString('en-US');
      document.getElementById('count-lux').textContent = cLux.toLocaleString('en-US');
    }

    function updateMarkers() {
      if (clusterGroup) {
        clusterGroup.clearLayers();
      } else {
        clusterGroup = L.markerClusterGroup({
          maxClusterRadius: 45,
          spiderfyOnMaxZoom: true,
          showCoverageOnHover: false,
          zoomToBoundsOnClick: true,
          disableClusteringAtZoom: 16,
          chunkedLoading: true,
          chunkInterval: 100,
          chunkDelay: 10,
          animate: false
        });
        map.addLayer(clusterGroup);
      }

      markers = filteredData.map(item => createMarker(item));
      clusterGroup.addLayers(markers);

      updateKPIs();
    }

    function populateFilters() {
      const neighborhoods = [...new Set(allData.map(x => x.city))].filter(Boolean).sort();
      const types = [...new Set(allData.map(x => x.type))].filter(Boolean).sort();

      const nSel = document.getElementById('neighborhood-filter');
      neighborhoods.forEach(n => {
        const opt = document.createElement('option');
        opt.value = n; opt.textContent = n;
        nSel.appendChild(opt);
      });

      const tSel = document.getElementById('type-filter');
      types.forEach(t => {
        const opt = document.createElement('option');
        opt.value = t; opt.textContent = t;
        tSel.appendChild(opt);
      });
    }

    function applyFilters() {
      const neighborhood = document.getElementById('neighborhood-filter').value;
      const type = document.getElementById('type-filter').value;
      const tier = document.getElementById('tier-filter').value;
      const view = document.getElementById('view-filter').value;

      let data = allData.filter(item => {
        const okN = neighborhood === "all" || item.city === neighborhood;
        const okT = type === "all" || item.type === type;
        const okTier = tier === "all" || item.tier === tier;
        return okN && okT && okTier;
      });

      if (view === "top20") data = topPercentByRevenue(data, 0.20);

      filteredData = data;
      updateMarkers();
      closePropertyPanel();
    }

    function setupDashboardToggle(){
      const dash = document.getElementById('dashboard');
      const btn = document.getElementById('toggle-btn');
      const text = document.getElementById('toggle-text');
      const icon = document.getElementById('toggle-icon');

      function setMinimized(min){
        dash.classList.toggle('minimized', min);
        text.textContent = min ? "Expand" : "Minimize";
        icon.style.transform = min ? "rotate(180deg)" : "rotate(0deg)";
      }

      // Mobile: start minimized
      const isMobile = window.matchMedia("(max-width: 768px)").matches;
      setMinimized(isMobile);

      btn.addEventListener('click', () => {
        setMinimized(!dash.classList.contains('minimized'));
      });
    }

    // =========================
    // INIT
    // =========================
    async function init(){
      setupDashboardToggle();

      map = L.map('map', { center: [23.5950, 58.4500], zoom: 12, zoomControl: true, preferCanvas: true });

      L.tileLayer('https://tiles.stadiamaps.com/tiles/alidade_smooth_dark/{z}/{x}/{y}{r}.png?api_key=ea1b3b5b-d0c0-4cb9-83d2-b68d9cd5a1ff', {
        attribution: '&copy; <a href="https://stadiamaps.com/">Stadia Maps</a>, &copy; <a href="https://openmaptiles.org/">OpenMapTiles</a> &copy; <a href="https://openstreetmap.org">OpenStreetMap</a> contributors',
        maxZoom: 20
      }).addTo(map);

      document.getElementById('p-close').addEventListener('click', closePropertyPanel);

      // Load datasets
      allData = await loadListingsCSV();
      filteredData = [...allData];

      populateFilters();
      updateMarkers();

      // filters
      document.getElementById('neighborhood-filter').addEventListener('change', applyFilters);
      document.getElementById('type-filter').addEventListener('change', applyFilters);
      document.getElementById('tier-filter').addEventListener('change', applyFilters);
      document.getElementById('view-filter').addEventListener('change', applyFilters);
    }

    init();
  </script>
</body>
</html>
