<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Muscat STR Market Size ‚Äî Investor Map</title>

  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    * { font-family: 'Space Grotesk', sans-serif; }
    body { background:#f6f7fb; }
    #map { z-index: 1; }
    .control-panel { z-index: 1000; }

    .custom-popup .leaflet-popup-content-wrapper{
      background: rgba(17,24,39,0.96);
      color:#fff;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.12);
      box-shadow: 0 16px 40px rgba(0,0,0,0.25);
    }
    .custom-popup .leaflet-popup-tip{ background: rgba(17,24,39,0.96); }

    /* Mobile: bottom-sheet */
    @media (max-width: 768px){
      #dashboard{
        left: 0 !important;
        right: 0 !important;
        top: auto !important;
        bottom: 0 !important;
        width: auto !important;
        max-height: 75vh;
        border-radius: 18px 18px 0 0;
        padding: 16px !important;
        overflow-y: auto;
      }
      #dashboard.minimized{
        max-height: 56px;
        overflow: hidden;
        padding: 12px 16px !important;
      }
      #dashboard.minimized #dashboard-body{ display:none; }

      /* Stack KPI grids to 2 columns on mobile */
      .kpi-grid { grid-template-columns: repeat(2, 1fr) !important; }
      /* Stack tier legend vertically */
      .tier-grid { grid-template-columns: 1fr !important; }
      /* Stack filters to single column */
      .filter-grid { grid-template-columns: 1fr !important; }
    }

    /* Small phones */
    @media (max-width: 380px){
      .kpi-grid { grid-template-columns: 1fr !important; }
    }

    /* Desktop: keep top-left */
    @media (min-width: 769px){
      #dashboard{
        top: 16px;
        left: 16px;
        right: auto;
        width: 30rem;
        max-height: calc(100vh - 32px);
      }
      #dashboard-body{
        overflow:auto;
        max-height: calc(100vh - 120px);
        padding-right: 4px;
      }
    }

    /* Mobile header compact */
    @media (max-width: 768px){
      #dashboard h1 { font-size: 1.15rem; }
      #dashboard-body {
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        max-height: calc(75vh - 80px);
        padding-right: 2px;
      }
    }
  </style>
</head>

<body class="h-full m-0 p-0">
  <div id="app-container" class="h-full w-full relative overflow-hidden">

    <!-- Dashboard -->
    <div id="dashboard" class="control-panel absolute bg-white/92 backdrop-blur-md rounded-2xl p-5 border border-gray-200 shadow-xl">
      <!-- Mobile drag handle -->
      <div class="md:hidden flex justify-center mb-2">
        <div class="w-10 h-1 rounded-full bg-gray-300"></div>
      </div>
      <!-- Header row -->
      <div class="flex items-start justify-between gap-3">
        <div>
          <h1 class="text-2xl font-bold text-gray-900 mb-1">Muscat STR Market Size</h1>
          <p class="text-gray-600 text-sm">Supply + Revenue Pool ‚Ä¢ Segmented by ADR Pricing Tier</p>
        </div>

        <div class="flex flex-col items-end gap-2">
          <div class="text-[11px] text-gray-500 text-right leading-tight hidden md:block">
            <div class="font-semibold text-gray-700">Sources</div>
            <div>AirROI Atlas (map)</div>
            <div>AirROI Excel (summary)</div>
          </div>

          <!-- Minimize button -->
          <button id="toggle-btn"
            class="inline-flex items-center gap-2 text-xs px-3 py-2 rounded-lg border border-gray-200 bg-white hover:bg-gray-50 text-gray-700 min-h-[36px]"
            aria-label="Minimize dashboard">
            <span id="toggle-text">Minimize</span>
            <svg id="toggle-icon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
            </svg>
          </button>
        </div>
      </div>

      <div id="dashboard-body" class="mt-4 space-y-4">
        <!-- KPIs from map listings -->
        <div class="kpi-grid grid grid-cols-3 gap-3">
          <div class="bg-gray-50 rounded-xl p-3 border border-gray-200">
            <div class="text-[11px] text-gray-500">Mapped listings</div>
            <div class="text-2xl font-bold text-gray-900" id="kpi-listings">--</div>
            <div class="text-[11px] text-gray-500">&nbsp;</div>
          </div>
          <div class="bg-gray-50 rounded-xl p-3 border border-gray-200">
            <div class="text-[11px] text-gray-500">Revenue pool</div>
            <div class="text-2xl font-bold text-emerald-600" id="kpi-total-rev">--</div>
            <div class="text-[11px] text-gray-500">OMR / month</div>
          </div>
          <div class="bg-gray-50 rounded-xl p-3 border border-gray-200">
            <div class="text-[11px] text-gray-500">Annualized</div>
            <div class="text-2xl font-bold text-indigo-600" id="kpi-annual">--</div>
            <div class="text-[11px] text-gray-500">OMR / year</div>
          </div>
        </div>

        <div class="kpi-grid grid grid-cols-3 gap-3">
          <div class="bg-gray-50 rounded-xl p-3 border border-gray-200">
            <div class="text-[11px] text-gray-500">Avg ADR</div>
            <div class="text-xl font-bold text-gray-900" id="kpi-adr">--</div>
            <div class="text-[11px] text-gray-500">OMR</div>
          </div>
          <div class="bg-gray-50 rounded-xl p-3 border border-gray-200">
            <div class="text-[11px] text-gray-500">Avg occupancy</div>
            <div class="text-xl font-bold text-gray-900" id="kpi-occ">--</div>
            <div class="text-[11px] text-gray-500">&nbsp;</div>
          </div>
          <div class="bg-gray-50 rounded-xl p-3 border border-gray-200">
            <div class="text-[11px] text-gray-500">Avg rev / listing</div>
            <div class="text-xl font-bold text-gray-900" id="kpi-avg-rev">--</div>
            <div class="text-[11px] text-gray-500">OMR / month</div>
          </div>
        </div>

        <!-- Tier legend + counts -->
        <div class="bg-white rounded-xl border border-gray-200 p-3">
          <div class="flex items-center justify-between">
            <div class="text-xs text-gray-700 font-semibold">Pricing tiers (ADR)</div>
            <div class="text-[11px] text-gray-500">Color = tier ‚Ä¢ Size = monthly revenue</div>
          </div>
          <div class="tier-grid mt-2 grid grid-cols-3 gap-2">
            <div class="flex items-center justify-between bg-gray-50 border border-gray-200 rounded-lg px-3 py-2">
              <div class="flex items-center gap-2">
                <span class="inline-block w-3 h-3 rounded-full" style="background:#000000"></span>
                <span class="text-xs text-gray-700">Low</span>
              </div>
              <span class="text-xs font-semibold text-gray-900" id="count-low">--</span>
            </div>
            <div class="flex items-center justify-between bg-gray-50 border border-gray-200 rounded-lg px-3 py-2">
              <div class="flex items-center gap-2">
                <span class="inline-block w-3 h-3 rounded-full" style="background:#2563eb"></span>
                <span class="text-xs text-gray-700">Mid</span>
              </div>
              <span class="text-xs font-semibold text-gray-900" id="count-mid">--</span>
            </div>
            <div class="flex items-center justify-between bg-gray-50 border border-gray-200 rounded-lg px-3 py-2">
              <div class="flex items-center gap-2">
                <span class="inline-block w-3 h-3 rounded-full" style="background:#D4AF37"></span>
                <span class="text-xs text-gray-700">Luxury</span>
              </div>
              <span class="text-xs font-semibold text-gray-900" id="count-lux">--</span>
            </div>
          </div>
          <div class="mt-2 text-[11px] text-gray-500">
            Thresholds: Low &lt; <span class="font-semibold" id="th-low">35</span> ‚Ä¢ Mid <span class="font-semibold" id="th-mid">35‚Äì55</span> ‚Ä¢ Luxury &gt; <span class="font-semibold" id="th-lux">55</span> (OMR ADR)
          </div>
        </div>

        <!-- Filters -->
        <div class="grid grid-cols-1 gap-3">
          <div class="filter-grid grid grid-cols-2 gap-3">
            <div>
              <label class="text-xs text-gray-600 mb-1 block">Neighborhood (City)</label>
              <select id="neighborhood-filter" class="w-full bg-white border border-gray-200 rounded-lg px-3 py-2 text-sm text-gray-900 focus:outline-none focus:ring-2 focus:ring-indigo-200">
                <option value="all">All</option>
              </select>
            </div>
            <div>
              <label class="text-xs text-gray-600 mb-1 block">Listing Type</label>
              <select id="type-filter" class="w-full bg-white border border-gray-200 rounded-lg px-3 py-2 text-sm text-gray-900 focus:outline-none focus:ring-2 focus:ring-indigo-200">
                <option value="all">All</option>
              </select>
            </div>
          </div>

          <div class="filter-grid grid grid-cols-2 gap-3">
            <div>
              <label class="text-xs text-gray-600 mb-1 block">Pricing tier</label>
              <select id="tier-filter" class="w-full bg-white border border-gray-200 rounded-lg px-3 py-2 text-sm text-gray-900 focus:outline-none focus:ring-2 focus:ring-indigo-200">
                <option value="all">All tiers</option>
                <option value="low">Low</option>
                <option value="mid">Mid</option>
                <option value="luxury">Luxury</option>
              </select>
            </div>
            <div>
              <label class="text-xs text-gray-600 mb-1 block">View</label>
              <select id="view-filter" class="w-full bg-white border border-gray-200 rounded-lg px-3 py-2 text-sm text-gray-900 focus:outline-none focus:ring-2 focus:ring-indigo-200">
                <option value="all">All listings</option>
                <option value="top20">Top 20% by revenue</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Excel Summary (new) -->
        <div class="bg-white rounded-xl border border-gray-200 p-3">
          <div class="flex items-center justify-between">
            <div class="text-xs text-gray-700 font-semibold">AirROI Executive Summary (2025)</div>
            <div class="text-[11px] text-gray-500">From Dashboard</div>
          </div>

          <div class="kpi-grid grid grid-cols-3 gap-2 mt-2">
            <div class="bg-gray-50 border border-gray-200 rounded-lg px-3 py-2">
              <div class="text-[11px] text-gray-500">2025 revenue</div>
              <div class="text-sm font-semibold text-gray-900" id="x-rev-2025">--</div>
            </div>
            <div class="bg-gray-50 border border-gray-200 rounded-lg px-3 py-2">
              <div class="text-[11px] text-gray-500">YoY growth</div>
              <div class="text-sm font-semibold text-gray-900" id="x-yoy">--</div>
            </div>
            <div class="bg-gray-50 border border-gray-200 rounded-lg px-3 py-2">
              <div class="text-[11px] text-gray-500">Active listings (Jan '26)</div>
              <div class="text-sm font-semibold text-gray-900" id="x-active">--</div>
            </div>
          </div>

          <div class="kpi-grid grid grid-cols-3 gap-2 mt-2">
            <div class="bg-gray-50 border border-gray-200 rounded-lg px-3 py-2">
              <div class="text-[11px] text-gray-500">Avg occ (2025)</div>
              <div class="text-sm font-semibold text-gray-900" id="x-occ">--</div>
            </div>
            <div class="bg-gray-50 border border-gray-200 rounded-lg px-3 py-2">
              <div class="text-[11px] text-gray-500">Avg ADR (2025)</div>
              <div class="text-sm font-semibold text-gray-900" id="x-adr">--</div>
            </div>
            <div class="bg-gray-50 border border-gray-200 rounded-lg px-3 py-2">
              <div class="text-[11px] text-gray-500">Booking rate (2025)</div>
              <div class="text-sm font-semibold text-gray-900" id="x-book">--</div>
            </div>
          </div>

          <div class="kpi-grid grid grid-cols-3 gap-2 mt-2">
            <div class="bg-gray-50 border border-gray-200 rounded-lg px-3 py-2">
              <div class="text-[11px] text-gray-500">Avg RevPAR (2025)</div>
              <div class="text-sm font-semibold text-gray-900" id="x-revpar">--</div>
            </div>
            <div class="bg-gray-50 border border-gray-200 rounded-lg px-3 py-2">
              <div class="text-[11px] text-gray-500">Supply growth</div>
              <div class="text-sm font-semibold text-gray-900" id="x-supply">--</div>
            </div>
            <div class="bg-gray-50 border border-gray-200 rounded-lg px-3 py-2">
              <div class="text-[11px] text-gray-500">Seasonality risk</div>
              <div class="text-sm font-semibold text-gray-900" id="x-seasonality">--</div>
            </div>
          </div>

          <div class="mt-3">
            <div class="flex items-center justify-between">
              <div class="text-[11px] text-gray-600 font-semibold">Monthly revenue trend</div>
              <div class="text-[11px] text-gray-500" id="sparkline-range">--</div>
            </div>
            <div class="mt-2 bg-gray-50 border border-gray-200 rounded-lg p-2">
              <svg id="sparkline" width="100%" height="54" viewBox="0 0 300 54" preserveAspectRatio="none">
                <path id="sparkline-path" d="" fill="none" stroke="#111827" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </div>
          </div>
        </div>

        <div class="text-[11px] text-gray-500">
          Tip: On mobile, tap ‚ÄúMinimize‚Äù to view the map. Click any point for Airbnb + Google Maps links.
        </div>
      </div>
    </div>

    <!-- Map -->
    <div id="map" class="h-full w-full"></div>

    <!-- Property panel -->
    <div id="property-panel" class="control-panel absolute bottom-4 left-4 right-4 md:left-auto md:right-4 md:w-96 bg-white/92 backdrop-blur-md rounded-2xl p-5 border border-gray-200 shadow-xl hidden">
      <div class="flex justify-between items-start mb-3">
        <h3 id="p-name" class="text-lg font-semibold text-gray-900 pr-2">Property</h3>
        <button id="p-close" class="text-gray-500 hover:text-gray-900 transition-colors" aria-label="Close">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>

      <div class="space-y-2 text-sm">
        <div class="flex justify-between"><span class="text-gray-500">City</span><span id="p-city" class="text-gray-900 font-medium">--</span></div>
        <div class="flex justify-between"><span class="text-gray-500">Listing Type</span><span id="p-type" class="text-gray-900 font-medium">--</span></div>
        <div class="flex justify-between"><span class="text-gray-500">Pricing tier</span><span id="p-tier" class="text-gray-900 font-medium">--</span></div>
        <div class="flex justify-between"><span class="text-gray-500">Monthly revenue</span><span id="p-rev" class="text-emerald-700 font-semibold">--</span></div>
        <div class="flex justify-between"><span class="text-gray-500">ADR</span><span id="p-adr" class="text-gray-900 font-medium">--</span></div>
        <div class="flex justify-between"><span class="text-gray-500">Occupancy</span><span id="p-occ" class="text-gray-900 font-medium">--</span></div>

        <div class="pt-3 flex gap-2">
          <a id="p-airbnb" target="_blank" rel="noopener noreferrer"
             class="flex-1 text-center text-sm px-3 py-2 rounded-lg bg-gray-900 text-white hover:bg-gray-800">
            Open Airbnb
          </a>
          <a id="p-maps" target="_blank" rel="noopener noreferrer"
             class="flex-1 text-center text-sm px-3 py-2 rounded-lg border border-gray-200 bg-white text-gray-900 hover:bg-gray-50">
            Open Maps
          </a>
        </div>
      </div>
    </div>

  </div>

  <script>
    // =========================
    // SETTINGS
    // =========================
    const ADR_LOW_MAX = 35;   // Low: < 35
    const ADR_MID_MAX = 55;   // Mid: 35‚Äì55, Luxury: > 55

    document.getElementById('th-low').textContent = ADR_LOW_MAX;
    document.getElementById('th-mid').textContent = `${ADR_LOW_MAX}‚Äì${ADR_MID_MAX}`;
    document.getElementById('th-lux').textContent = ADR_MID_MAX;

    // Files (place alongside this HTML on GitHub Pages)
    const LISTINGS_CSV_URL = "./airroi_atlas_all_listings_with_airbnb_ids.csv";
    const EXCEL_SUMMARY_JSON_URL = "./market_summary.json";

    // =========================
    // STATE
    // =========================
    let map;
    let markers = [];
    let allData = [];
    let filteredData = [];

    // =========================
    // HELPERS
    // =========================
    const fmtOMR = (n) => Number(n || 0).toLocaleString('en-US', { maximumFractionDigits: 0 });
    const clamp = (v, min, max) => Math.max(min, Math.min(max, v));

    function tierFromADR(adr){
      const a = Number(adr || 0);
      if (a > ADR_MID_MAX) return "luxury";
      if (a >= ADR_LOW_MAX) return "mid";
      return "low";
    }
    function tierLabel(t){
      if (t === "luxury") return "Luxury";
      if (t === "mid") return "Mid";
      return "Low";
    }
    function tierColor(t){
      if (t === "luxury") return "#D4AF37";
      if (t === "mid") return "#2563eb";
      return "#000000";
    }
    function markerSizeFromRevenue(rev){
      const r = Math.sqrt(Math.max(0, Number(rev || 0))) * 0.35;
      return clamp(r, 10, 34);
    }
    function topPercentByRevenue(data, pct){
      const sorted = [...data].sort((a,b)=> (b.revenue||0) - (a.revenue||0));
      const k = Math.max(1, Math.round(sorted.length * pct));
      return sorted.slice(0, k);
    }

    // =========================
    // CSV PARSE (simple, robust for this export)
    // =========================
    function parseCSVLine(line){
      // handles commas inside quotes
      const out = [];
      let cur = "";
      let inQuotes = false;
      for (let i=0; i<line.length; i++){
        const ch = line[i];
        if (ch === '"'){
          if (inQuotes && line[i+1] === '"'){ cur += '"'; i++; }
          else inQuotes = !inQuotes;
        } else if (ch === ',' && !inQuotes){
          out.push(cur); cur = "";
        } else {
          cur += ch;
        }
      }
      out.push(cur);
      return out;
    }

    function normalizeHeaderName(value){
      return (value || "")
        .toString()
        .trim()
        .toLowerCase()
        .replace(/\s+/g, " ");
    }

    function getColumnIndex(headerMap, candidates){
      for (const candidate of candidates){
        const idx = headerMap[normalizeHeaderName(candidate)];
        if (Number.isInteger(idx)) return idx;
      }
      return -1;
    }

    function splitCSVRows(text){
      // Split CSV text into logical rows, respecting quoted fields that may
      // contain embedded newlines.
      const rows = [];
      let cur = "";
      let inQuotes = false;
      for (let i = 0; i < text.length; i++){
        const ch = text[i];
        if (ch === '"'){
          if (inQuotes && text[i+1] === '"'){ cur += '""'; i++; }
          else inQuotes = !inQuotes;
          cur += ch;
        } else if ((ch === '\n' || ch === '\r') && !inQuotes){
          if (ch === '\r' && text[i+1] === '\n') i++; // skip \r\n
          if (cur.trim().length) rows.push(cur);
          cur = "";
        } else {
          cur += ch;
        }
      }
      if (cur.trim().length) rows.push(cur);
      return rows;
    }

    async function loadListingsCSV(){
      const res = await fetch(LISTINGS_CSV_URL);
      const text = await res.text();
      const lines = splitCSVRows(text);

      // skip comment lines that start with '#'
      const dataLines = lines.filter(l => !l.trim().startsWith("#"));
      if (dataLines.length < 2) return [];

      // header row is the first non-comment line
      const header = parseCSVLine(dataLines[0]);
      const headerMap = {};
      header.forEach((name, idx) => {
        headerMap[normalizeHeaderName(name)] = idx;
      });

      const idxListingId = getColumnIndex(headerMap, ["Listing ID"]);
      const idxName = getColumnIndex(headerMap, ["Name", "listingName"]);
      const idxLatitude = getColumnIndex(headerMap, ["Latitude", "latitude"]);
      const idxLongitude = getColumnIndex(headerMap, ["Longitude", "longitude"]);
      const idxGoogleMapsUrl = getColumnIndex(headerMap, ["Google Maps URL", "googleMapsLink"]);
      const idxAirbnbUrl = getColumnIndex(headerMap, ["Airbnb URL", "AirBnBLink"]);
      const idxPropertyType = getColumnIndex(headerMap, ["Property Type", "listingType"]);
      const idxRoomType = getColumnIndex(headerMap, ["Room Type"]);
      const idxAnnualRevenue = getColumnIndex(headerMap, ["Annual Revenue LTM (USD)", "RevenuePerYear"]);
      const idxAdr = getColumnIndex(headerMap, ["Avg Daily Rate LTM (USD)", "ADR"]);
      const idxOccupancy = getColumnIndex(headerMap, ["Avg Occupancy Rate LTM (%)", "occupancyRate"]);

      const rows = dataLines.slice(1).map(parseCSVLine);

      const parsed = [];
      for (const r of rows){
        if (!r || !r.length) continue;

        const listingName = (r[idxName] || "").replace(/[\r\n]+/g, " ").trim();
        const propertyType = (r[idxPropertyType] || "").trim();
        const roomType = (r[idxRoomType] || "").trim();
        const listingType = [propertyType, roomType].filter(Boolean).join(" ‚Ä¢ ") || propertyType || "‚Äî";

        const lat = Number((r[idxLatitude] || "").trim());
        const lng = Number((r[idxLongitude] || "").trim());
        if (!Number.isFinite(lat) || !Number.isFinite(lng) || (lat === 0 && lng === 0)) continue;

        const googleMapsLinkRaw = (r[idxGoogleMapsUrl] || "").trim();
        const maybeAirbnbUrl = (r[idxAirbnbUrl] || "").trim();
        const airbnbListingIdMatch = maybeAirbnbUrl.match(/rooms\/(\d+)/);
        const listingIdRaw = (r[idxListingId] || "").trim();
        const airbnbListingId = airbnbListingIdMatch ? airbnbListingIdMatch[1] : listingIdRaw;
        
        const airbnbUrl = (maybeAirbnbUrl.includes("airbnb.com/rooms"))
          ? maybeAirbnbUrl
          : (airbnbListingId ? `https://www.airbnb.com/rooms/${airbnbListingId}` : "");

        const city = "Muscat";

        const annualRevenue = Number((r[idxAnnualRevenue] || "").trim());
        const revenue_omr = annualRevenue / 12;
        const adr = Number((r[idxAdr] || "").trim());
        const rawOcc = Number((r[idxOccupancy] || "").trim());
        const occ_pct = rawOcc <= 1 ? rawOcc * 100 : rawOcc;
        
        const mapsUrl = (googleMapsLinkRaw && googleMapsLinkRaw.startsWith("http"))
          ? googleMapsLinkRaw
          : `https://www.google.com/maps?q=${lat},${lng}`;

        const tier = tierFromADR(adr);

        parsed.push({
          id: airbnbListingId || `${lat},${lng},${listingName}`,
          airbnbListingId,
          name: listingName || "Airbnb listing",
          type: listingType || "‚Äî",
          city,
          lat, lng,
          mapsUrl,
          airbnbUrl,
          revenue: Number.isFinite(revenue_omr) ? revenue_omr : 0,
          adr: Number.isFinite(adr) ? adr : 0,
          occupancy: Number.isFinite(occ_pct) ? clamp(occ_pct, 0, 100) : 0,
          tier
        });
      }

      return parsed;
    }

    // =========================
    // EXCEL SUMMARY LOAD + SPARKLINE
    // =========================
    function sparklinePath(values){
      const w = 300, h = 54, pad = 4;
      const v = values.filter(x => Number.isFinite(x));
      if (!v.length) return "";

      const min = Math.min(...v), max = Math.max(...v);
      const range = (max - min) || 1;

      const step = (w - pad*2) / (v.length - 1 || 1);
      let d = "";
      v.forEach((val, i) => {
        const x = pad + i * step;
        const y = pad + (h - pad*2) * (1 - (val - min) / range);
        d += (i === 0 ? "M" : "L") + x.toFixed(2) + "," + y.toFixed(2);
      });
      return d;
    }

    async function loadExcelSummary(){
      try{
        const res = await fetch(EXCEL_SUMMARY_JSON_URL);
        const summary = await res.json();

        const k = summary.kpi_2025 || {};
        document.getElementById('x-rev-2025').textContent = `${fmtOMR(k.total_market_revenue_omr)} OMR`;
        document.getElementById('x-yoy').textContent = k.yoy_revenue_growth || "--";
        document.getElementById('x-active').textContent = (k.active_listings_jan_2026 ?? "--").toString();
        document.getElementById('x-occ').textContent = (Number.isFinite(k.avg_occupancy_2025) ? Math.round(k.avg_occupancy_2025*100) + "%" : "--");
        document.getElementById('x-adr').textContent = (Number.isFinite(k.avg_adr_2025_omr) ? `${Math.round(k.avg_adr_2025_omr)} OMR` : "--");
        document.getElementById('x-book').textContent = (Number.isFinite(k.avg_booking_rate_2025) ? Math.round(k.avg_booking_rate_2025*100) + "%" : "--");
        document.getElementById('x-revpar').textContent = (Number.isFinite(k.avg_revpar_2025_omr) ? `${k.avg_revpar_2025_omr.toFixed(2)} OMR` : "--");
        document.getElementById('x-supply').textContent = (Number.isFinite(k.supply_growth_mar_2023_to_jan_2026) ? Math.round(k.supply_growth_mar_2023_to_jan_2026*100) + "%" : "--");
        document.getElementById('x-seasonality').textContent = (summary.market_health && summary.market_health.seasonality_risk)
          ? summary.market_health.seasonality_risk.replace('_', ' ')
          : "--";

        const series = (summary.monthly_tracker || []).map(x => Number(x.revenue_omr));
        const labels = (summary.monthly_tracker || []).map(x => x.month);
        if (labels.length){
          document.getElementById('sparkline-range').textContent = `${labels[0]} ‚Üí ${labels[labels.length-1]}`;
        }
        document.getElementById('sparkline-path').setAttribute('d', sparklinePath(series));
      } catch(e){
        // If summary file missing, leave blank (map still works)
        console.warn("Excel summary load failed:", e);
      }
    }

    // =========================
    // MARKERS + UI
    // =========================
    function createMarker(item) {
      const color = tierColor(item.tier);
      const size = markerSizeFromRevenue(item.revenue);

      const markerHtml = `
        <div style="
          width:${size}px;height:${size}px;
          background:${color};
          border:2px solid rgba(255,255,255,0.9);
          border-radius:9999px;
          box-shadow:0 10px 22px rgba(0,0,0,0.22);
          cursor:pointer;
          transition: transform 0.15s ease;
        "></div>
      `;

      const icon = L.divIcon({
        html: markerHtml,
        className: 'custom-marker',
        iconSize: [size, size],
        iconAnchor: [size/2, size/2]
      });

      const marker = L.marker([item.lat, item.lng], { icon })
        .bindPopup(`
          <div class="p-2">
            <div class="font-semibold text-base mb-2">${item.name}</div>
            <div class="text-gray-300 text-xs space-y-1">
              <div>üìç ${item.city}</div>
              <div>üè† ${item.type}</div>
              <div>üè∑ Tier: <span style="color:${color};font-weight:700">${tierLabel(item.tier)}</span></div>
              <div>üí∞ Monthly: <span style="color:#10b981">${fmtOMR(item.revenue)} OMR</span></div>
              <div>üìà ADR: ${Math.round(item.adr)} OMR | Occ: ${Math.round(item.occupancy)}%</div>
              <div class="pt-2 flex gap-2">
                <a href="${item.airbnbUrl}" target="_blank" rel="noopener noreferrer"
                   style="display:inline-block;padding:6px 10px;border-radius:10px;background:#111827;color:#fff;font-weight:600;text-decoration:none;">
                  Airbnb
                </a>
                <a href="${item.mapsUrl}" target="_blank" rel="noopener noreferrer"
                   style="display:inline-block;padding:6px 10px;border-radius:10px;background:#fff;color:#111827;font-weight:600;text-decoration:none;border:1px solid rgba(255,255,255,0.18);">
                  Maps
                </a>
              </div>
            </div>
          </div>
        `, { className: 'custom-popup' });

      // hover effect
      marker.on('mouseover', function(){
        const el = this.getElement();
        if (el) el.firstChild && (el.firstChild.style.transform = "scale(1.12)");
      });
      marker.on('mouseout', function(){
        const el = this.getElement();
        if (el) el.firstChild && (el.firstChild.style.transform = "scale(1)");
      });

      return marker;
    }

    function showPropertyPanel(item) {
      document.getElementById('p-name').textContent = item.name;
      document.getElementById('p-city').textContent = item.city;
      document.getElementById('p-type').textContent = item.type;
      document.getElementById('p-tier').textContent = tierLabel(item.tier);
      document.getElementById('p-rev').textContent = `${fmtOMR(item.revenue)} OMR / month`;
      document.getElementById('p-adr').textContent = `${Math.round(item.adr)} OMR`;
      document.getElementById('p-occ').textContent = `${Math.round(item.occupancy)}%`;

      const airbnbA = document.getElementById('p-airbnb');
      const mapsA = document.getElementById('p-maps');
      airbnbA.href = item.airbnbUrl || "#";
      mapsA.href = item.mapsUrl || "#";

      document.getElementById('property-panel').classList.remove('hidden');
    }

    function closePropertyPanel() {
      document.getElementById('property-panel').classList.add('hidden');
    }

    function updateKPIs() {
      const n = filteredData.length;
      document.getElementById('kpi-listings').textContent = n.toLocaleString('en-US');

      if (!n) {
        document.getElementById('kpi-total-rev').textContent = "--";
        document.getElementById('kpi-annual').textContent = "--";
        document.getElementById('kpi-adr').textContent = "--";
        document.getElementById('kpi-occ').textContent = "--";
        document.getElementById('kpi-avg-rev').textContent = "--";
        document.getElementById('count-low').textContent = "--";
        document.getElementById('count-mid').textContent = "--";
        document.getElementById('count-lux').textContent = "--";
        return;
      }

      const totalRev = filteredData.reduce((s, x) => s + (x.revenue || 0), 0);
      const annual = totalRev * 12;
      const avgRev = totalRev / n;
      const adrItems = filteredData.filter(x => x.adr > 0);
      const occItems = filteredData.filter(x => x.occupancy > 0);
      const avgAdr = adrItems.length ? adrItems.reduce((s, x) => s + x.adr, 0) / adrItems.length : 0;
      const avgOcc = occItems.length ? occItems.reduce((s, x) => s + x.occupancy, 0) / occItems.length : 0;

      document.getElementById('kpi-total-rev').textContent = fmtOMR(Math.round(totalRev));
      document.getElementById('kpi-annual').textContent = fmtOMR(Math.round(annual));
      document.getElementById('kpi-avg-rev').textContent = fmtOMR(Math.round(avgRev));
      document.getElementById('kpi-adr').textContent = fmtOMR(Math.round(avgAdr));
      document.getElementById('kpi-occ').textContent = `${Math.round(avgOcc)}%`;

      const cLow = filteredData.filter(x => x.tier === "low").length;
      const cMid = filteredData.filter(x => x.tier === "mid").length;
      const cLux = filteredData.filter(x => x.tier === "luxury").length;
      document.getElementById('count-low').textContent = cLow.toLocaleString('en-US');
      document.getElementById('count-mid').textContent = cMid.toLocaleString('en-US');
      document.getElementById('count-lux').textContent = cLux.toLocaleString('en-US');
    }

    function updateMarkers() {
      markers.forEach(m => map.removeLayer(m));
      markers = [];

      filteredData.forEach(item => {
        const marker = createMarker(item);
        marker.addTo(map);
        markers.push(marker);
      });

      updateKPIs();
    }

    function populateFilters() {
      const neighborhoods = [...new Set(allData.map(x => x.city))].filter(Boolean).sort();
      const types = [...new Set(allData.map(x => x.type))].filter(Boolean).sort();

      const nSel = document.getElementById('neighborhood-filter');
      neighborhoods.forEach(n => {
        const opt = document.createElement('option');
        opt.value = n; opt.textContent = n;
        nSel.appendChild(opt);
      });

      const tSel = document.getElementById('type-filter');
      types.forEach(t => {
        const opt = document.createElement('option');
        opt.value = t; opt.textContent = t;
        tSel.appendChild(opt);
      });
    }

    function applyFilters() {
      const neighborhood = document.getElementById('neighborhood-filter').value;
      const type = document.getElementById('type-filter').value;
      const tier = document.getElementById('tier-filter').value;
      const view = document.getElementById('view-filter').value;

      let data = allData.filter(item => {
        const okN = neighborhood === "all" || item.city === neighborhood;
        const okT = type === "all" || item.type === type;
        const okTier = tier === "all" || item.tier === tier;
        return okN && okT && okTier;
      });

      if (view === "top20") data = topPercentByRevenue(data, 0.20);

      filteredData = data;
      updateMarkers();
      closePropertyPanel();
    }

    function setupDashboardToggle(){
      const dash = document.getElementById('dashboard');
      const btn = document.getElementById('toggle-btn');
      const text = document.getElementById('toggle-text');
      const icon = document.getElementById('toggle-icon');

      function setMinimized(min){
        dash.classList.toggle('minimized', min);
        text.textContent = min ? "Expand" : "Minimize";
        icon.style.transform = min ? "rotate(180deg)" : "rotate(0deg)";
      }

      // Mobile: start minimized
      const isMobile = window.matchMedia("(max-width: 768px)").matches;
      setMinimized(isMobile);

      btn.addEventListener('click', () => {
        setMinimized(!dash.classList.contains('minimized'));
      });
    }

    // =========================
    // INIT
    // =========================
    async function init(){
      setupDashboardToggle();

      map = L.map('map', { center: [23.5950, 58.4500], zoom: 12, zoomControl: true });

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors',
        maxZoom: 19
      }).addTo(map);

      document.getElementById('p-close').addEventListener('click', closePropertyPanel);

      // Load datasets
      allData = await loadListingsCSV();
      filteredData = [...allData];

      populateFilters();
      updateMarkers();

      // Excel summary in parallel
      loadExcelSummary();

      // filters
      document.getElementById('neighborhood-filter').addEventListener('change', applyFilters);
      document.getElementById('type-filter').addEventListener('change', applyFilters);
      document.getElementById('tier-filter').addEventListener('change', applyFilters);
      document.getElementById('view-filter').addEventListener('change', applyFilters);
    }

    init();
  </script>
</body>
</html>
